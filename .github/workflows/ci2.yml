name: Complete CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    # [QUAN TRỌNG] Cấu hình MySQL Service thay vì PostgreSQL
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: testdb
          MYSQL_ROOT_PASSWORD: password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # 1. Lấy code về
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Cài đặt k6 (Để phục vụ script test:load)
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # 3. Cài đặt Java 17
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 4. Cài đặt Node.js 20
      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 5. Chạy Backend Tests
      # Đã sửa cấu hình kết nối sang MySQL
      - name: Run Backend Tests
        run: |
          cd backend
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/testdb
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: password
          # Dòng này giúp Hibernate tự tạo bảng trong DB ảo
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop 

      # 6. Cài đặt dependencies Frontend
      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm install

      # 7. Chạy Frontend Unit Tests (Jest)
      - name: Run Frontend Unit Tests
        run: |
          cd frontend
          npm run test:ci

      # 8. Chạy Performance Test (k6) - Kiểm tra script chạy được không
      - name: Verify k6 Script
        run: |
          cd frontend
          k6 version
          # Chỉ kiểm tra cú pháp file loadtest.js có đúng không
          # (Không chạy thật vì cần backend đang active)