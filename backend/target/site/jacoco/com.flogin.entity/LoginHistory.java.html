<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginHistory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Flogin Backend</a> &gt; <a href="index.source.html" class="el_package">com.flogin.entity</a> &gt; <span class="el_source">LoginHistory.java</span></div><h1>LoginHistory.java</h1><pre class="source lang-java linenums">package com.flogin.entity;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;

/**
 * Entity class representing Login History
 * Tracks all login attempts for security and audit purposes
 */
@Entity
@Table(name = &quot;login_history&quot;, indexes = {
    @Index(name = &quot;idx_user_id&quot;, columnList = &quot;user_id&quot;),
    @Index(name = &quot;idx_username&quot;, columnList = &quot;username&quot;),
    @Index(name = &quot;idx_login_time&quot;, columnList = &quot;login_time&quot;),
    @Index(name = &quot;idx_is_success&quot;, columnList = &quot;is_success&quot;)
})
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LoginHistory {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // Nullable - vì có thể login với username không tồn tại
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;user_id&quot;, foreignKey = @ForeignKey(name = &quot;fk_login_history_user&quot;))
    private User user;

    @NotBlank(message = &quot;Username is required&quot;)
    @Size(max = 50, message = &quot;Username must not exceed 50 characters&quot;)
    @Column(nullable = false, length = 50)
    private String username;

    @Size(max = 45, message = &quot;IP address must not exceed 45 characters&quot;)
    @Column(name = &quot;ip_address&quot;, length = 45)
    private String ipAddress;

    @Size(max = 255, message = &quot;User agent must not exceed 255 characters&quot;)
    @Column(name = &quot;user_agent&quot;, length = 255)
    private String userAgent;

    @NotNull(message = &quot;Success status is required&quot;)
    @Column(name = &quot;is_success&quot;, nullable = false)
    private Boolean isSuccess;

    @Size(max = 255, message = &quot;Failure reason must not exceed 255 characters&quot;)
    @Column(name = &quot;failure_reason&quot;, length = 255)
    private String failureReason;

    @CreationTimestamp
    @Column(name = &quot;login_time&quot;, nullable = false, updatable = false)
    private LocalDateTime loginTime;

    /**
     * Constructor for successful login
     */
<span class="nc" id="L67">    public LoginHistory(User user, String ipAddress, String userAgent) {</span>
<span class="nc" id="L68">        this.user = user;</span>
<span class="nc" id="L69">        this.username = user.getUsername();</span>
<span class="nc" id="L70">        this.ipAddress = ipAddress;</span>
<span class="nc" id="L71">        this.userAgent = userAgent;</span>
<span class="nc" id="L72">        this.isSuccess = true;</span>
<span class="nc" id="L73">        this.failureReason = null;</span>
<span class="nc" id="L74">    }</span>

    /**
     * Constructor for failed login
     */
<span class="nc" id="L79">    public LoginHistory(String username, String ipAddress, String userAgent, String failureReason) {</span>
<span class="nc" id="L80">        this.user = null;</span>
<span class="nc" id="L81">        this.username = username;</span>
<span class="nc" id="L82">        this.ipAddress = ipAddress;</span>
<span class="nc" id="L83">        this.userAgent = userAgent;</span>
<span class="nc" id="L84">        this.isSuccess = false;</span>
<span class="nc" id="L85">        this.failureReason = failureReason;</span>
<span class="nc" id="L86">    }</span>

    /**
     * Constructor with all fields
     */
<span class="nc" id="L91">    public LoginHistory(User user, String username, String ipAddress, String userAgent, </span>
                       Boolean isSuccess, String failureReason) {
<span class="nc" id="L93">        this.user = user;</span>
<span class="nc" id="L94">        this.username = username;</span>
<span class="nc" id="L95">        this.ipAddress = ipAddress;</span>
<span class="nc" id="L96">        this.userAgent = userAgent;</span>
<span class="nc" id="L97">        this.isSuccess = isSuccess;</span>
<span class="nc" id="L98">        this.failureReason = failureReason;</span>
<span class="nc" id="L99">    }</span>

    /**
     * Check if login was successful
     */
    public boolean isSuccessful() {
<span class="nc bnc" id="L105" title="All 4 branches missed.">        return this.isSuccess != null &amp;&amp; this.isSuccess;</span>
    }

    /**
     * Check if login failed
     */
    public boolean isFailed() {
<span class="nc bnc" id="L112" title="All 4 branches missed.">        return this.isSuccess == null || !this.isSuccess;</span>
    }

    /**
     * Get formatted login time
     */
    @Transient
    public String getFormattedLoginTime() {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (loginTime == null) return &quot;N/A&quot;;</span>
<span class="nc" id="L121">        return loginTime.toString();</span>
    }

    /**
     * Get login status text
     */
    @Transient
    public String getStatusText() {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        return isSuccessful() ? &quot;Success&quot; : &quot;Failed&quot;;</span>
    }

    /**
     * Common failure reasons
     */
<span class="nc" id="L135">    public static class FailureReason {</span>
        public static final String USERNAME_NOT_FOUND = &quot;Username not found&quot;;
        public static final String INVALID_PASSWORD = &quot;Invalid password&quot;;
        public static final String ACCOUNT_DISABLED = &quot;Account is disabled&quot;;
        public static final String ACCOUNT_LOCKED = &quot;Account is locked&quot;;
        public static final String TOO_MANY_ATTEMPTS = &quot;Too many login attempts&quot;;
        public static final String INVALID_CREDENTIALS = &quot;Invalid credentials&quot;;
        public static final String VALIDATION_ERROR = &quot;Validation error&quot;;
    }

    /**
     * Create success login history
     */
    public static LoginHistory createSuccessHistory(User user, String ipAddress, String userAgent) {
<span class="nc" id="L149">        return new LoginHistory(user, ipAddress, userAgent);</span>
    }

    /**
     * Create failed login history
     */
    public static LoginHistory createFailureHistory(String username, String ipAddress, 
                                                    String userAgent, String failureReason) {
<span class="nc" id="L157">        return new LoginHistory(username, ipAddress, userAgent, failureReason);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L162">        return &quot;LoginHistory{&quot; +</span>
<span class="nc" id="L163">                &quot;id=&quot; + id +</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                &quot;, userId=&quot; + (user != null ? user.getId() : null) +</span>
<span class="nc" id="L165">                &quot;, username='&quot; + username + '\'' +</span>
<span class="nc" id="L166">                &quot;, ipAddress='&quot; + ipAddress + '\'' +</span>
<span class="nc" id="L167">                &quot;, isSuccess=&quot; + isSuccess +</span>
<span class="nc" id="L168">                &quot;, failureReason='&quot; + failureReason + '\'' +</span>
<span class="nc" id="L169">                &quot;, loginTime=&quot; + loginTime +</span>
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>